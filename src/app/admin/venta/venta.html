<div class="ventas-container">
  <!-- Header -->
  <div class="header-card">
    <div class="toolbar">
      <div class="toolbar-left">
        <h2 class="page-title">
          <i class="icon-shopping-bag"></i>
          <span>Gestión de Ventas</span>
        </h2>
      </div>

      <div class="toolbar-right">
        <button class="btn btn-success" (click)="openNew()">
          <i class="icon-plus"></i>
          Nueva Venta
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla Container -->
  <div class="table-container">
    <!-- Table Header Controls -->
    <div class="table-header">
      <h3 class="table-title">Listado de Ventas</h3>

      <div class="table-actions">
        <div class="search-box">
          <i class="icon-search"></i>
          <input
            type="text"
            placeholder="Buscar..."
            (input)="onSearch($event)"
            class="search-input"
          />
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Cargando ventas...</p>
    </div>

    <!-- Tabla -->
    <div *ngIf="!loading" class="table-wrapper">
      <table class="custom-table">
        <thead>
          <tr>
            <th class="sortable" (click)="sort('id')">
              ID
              <i class="icon-{{ getSortIcon('id') }}"></i>
            </th>
            <th class="sortable" (click)="sort('fecha')">
              Fecha
              <i class="icon-{{ getSortIcon('fecha') }}"></i>
            </th>
            <th>Usuario</th>
            <th>Productos</th>
            <th class="sortable" (click)="sort('total')">
              Total
              <i class="icon-{{ getSortIcon('total') }}"></i>
            </th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let venta of filteredVentas">
            <td class="font-bold">{{ venta.id }}</td>
            <td>{{ venta.fecha | date: 'dd/MM/yyyy' }}</td>
            <td>{{ getUsuarioNombre(venta.usuarioId!) }}</td>
            <td>
              <ul class="productos-list">
                <li *ngFor="let detalle of venta.detalles">
                  {{ detalle.producto?.nombre || 'Producto no encontrado' }} - {{ detalle.cantidad }} u.
                </li>
              </ul>
            </td>
            <td>{{ getTotalVenta(venta) | currency }}</td>
            <td>{{ venta.estado }}</td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn-icon btn-view"
                  (click)="viewVenta(venta)"
                  title="Ver Detalles"
                >
                  <i class="icon-eye"></i>
                </button>
              </div>
            </td>
          </tr>

          <tr *ngIf="filteredVentas.length === 0" class="no-data">
            <td colspan="7" class="text-center">No se encontraron ventas</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="!loading && totalItems > 0" class="pagination-container">
      <div class="pagination-info">{{ getPaginationInfo() }}</div>

      <div class="pagination-controls">
        <select
          class="items-per-page"
          [value]="itemsPerPage"
          (change)="changeItemsPerPage($event)"
        >
          <option *ngFor="let option of itemsPerPageOptions" [value]="option">
            {{ option }} por página
          </option>
        </select>

        <div class="page-buttons">
          <button
            class="btn btn-sm"
            [disabled]="currentPage <= 1"
            (click)="goToPage(currentPage - 1)"
          >
            Anterior
          </button>

          <span class="page-info">
            Página {{ currentPage }} de {{ totalPages }}
          </span>

          <button
            class="btn btn-sm"
            [disabled]="currentPage >= totalPages"
            (click)="goToPage(currentPage + 1)"
          >
            Siguiente
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Agregar -->
<div
  class="modal-overlay"
  *ngIf="dialogVisible"
  (click)="hideDialog()"
>
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Nueva Venta</h3>
      <button class="btn-close" (click)="hideDialog()">
        <i class="icon-close"></i>
      </button>
    </div>

    <form [formGroup]="ventaForm" (ngSubmit)="saveVenta()">
      <div class="modal-body">
        
        <!-- Selección de Cliente -->
        <div class="form-group">
          <label for="usuarioId" class="form-label">
            <strong>Usuario *</strong>
          </label>
          <select 
            id="usuarioId"
            formControlName="usuarioId" 
            class="form-control"
            [class.is-invalid]="usuarioControl?.invalid && (usuarioControl?.dirty || usuarioControl?.touched || submitted)"
          >
            <option value="">Seleccione un usuario</option>
            <option *ngFor="let usuario of usuarios" [value]="usuario.id">
              {{ usuario.fullName }} ({{ usuario.email }})
            </option>
          </select>
          <div *ngIf="usuarioControl?.invalid && (usuarioControl?.dirty || usuarioControl?.touched || submitted)" class="error-message">
            Usuario es requerido
          </div>
        </div>

        <!-- Tabla de detalles -->
        <h4>Detalles de Venta</h4>
        <table class="table table-bordered" formArrayName="detalles">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Precio Unitario</th>
              <th>Cantidad</th>
              <th>Subtotal</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detalle of detalles.controls; let i = index" [formGroupName]="i">
              <td>
                <select 
                  formControlName="productoId" 
                  class="form-control" 
                  (change)="onProductoChange(i)"
                  [class.is-invalid]="getProductoControl(i)?.invalid && (getProductoControl(i)?.dirty || getProductoControl(i)?.touched || submitted)"
                >
                  <option [ngValue]="null">Seleccione producto</option>
                  <option *ngFor="let producto of productos" [value]="producto.id">
                    {{ producto.nombre }}
                  </option>
                </select>
                <div *ngIf="getProductoControl(i)?.invalid && (getProductoControl(i)?.dirty || getProductoControl(i)?.touched || submitted)" class="error-message">
                  Producto es requerido
                </div>
              </td>
              <td>
                <span class="precio-display">
                  {{ getProductoPrecio(detalle.get('productoId')?.value) | currency }}
                </span>
              </td>
              <td>
                <input 
                  type="number" 
                  formControlName="cantidad" 
                  class="form-control" 
                  min="1"
                  (input)="onCantidadChange(i)"
                  [class.is-invalid]="getCantidadControl(i)?.invalid && (getCantidadControl(i)?.dirty || getCantidadControl(i)?.touched || submitted)"
                />
                <div *ngIf="getCantidadControl(i)?.invalid && (getCantidadControl(i)?.dirty || getCantidadControl(i)?.touched || submitted)" class="error-message">
                  Cantidad mínima: 1
                </div>
              </td>
              <td>
                <span class="subtotal-display">
                  {{ detalle.get('subtotal')?.value | currency }}
                </span>
              </td>
              <td>
                <button type="button" class="btn btn-danger btn-sm" (click)="removeDetalle(i)" *ngIf="detalles.length > 1">
                  <i class="icon-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Botón para agregar más filas -->
        <button type="button" class="btn btn-outline-primary" (click)="addDetalle()">
          <i class="icon-plus"></i>
          Agregar Producto
        </button>

        <div class="mt-3 text-end">
          <strong class="total-venta">Total Venta: {{ calcularTotalVenta() | currency }}</strong>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline" (click)="hideDialog()">
          Cancelar
        </button>
        <button 
          type="submit" 
          class="btn btn-success" 
          [disabled]="ventaForm.invalid || detalles.length === 0"
        >
          <i class="icon-save"></i>
          Guardar Venta
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Visualización -->
<div
  class="modal-overlay"
  *ngIf="viewDialogVisible"
  (click)="viewDialogVisible = false"
>
  <div class="modal-container large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalles de Venta #{{ selectedVenta?.id }}</h3>
      <button class="btn-close" (click)="viewDialogVisible = false">
        <i class="icon-close"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="venta-info">
        <div class="info-row">
          <span class="info-label">Fecha:</span>
          <span class="info-value">{{ selectedVenta?.fecha | date: 'dd/MM/yyyy HH:mm' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Usuario:</span>
          <span class="info-value">{{ getUsuarioNombre(selectedVenta?.usuarioId!) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Estado:</span>
          <span class="info-value">{{ selectedVenta?.estado }}</span>
        </div>
      </div>

      <div class="details-table">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detalle of selectedVenta?.detalles">
              <td>{{ detalle.producto?.nombre || 'Producto no encontrado' }}</td>
              <td>{{ detalle.cantidad }}</td>
              <td>{{ detalle.precioUnitario | currency }}</td>
              <td>{{ detalle.subtotal | currency }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="total-label">Total Venta:</td>
              <td class="total-value">{{ getTotalVenta(selectedVenta!) | currency }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="viewDialogVisible = false">
        Cerrar
      </button>
    </div>
  </div>
</div>